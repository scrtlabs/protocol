

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing a Secret Contract &mdash; Enigma Protocol 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/css/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Enigma Protocol 0.1 documentation" href="index.html"/>
        <link rel="next" title="Creating a React Front-End" href="CreateReactFrontend.html"/>
        <link rel="prev" title="Getting Started" href="GettingStarted.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="index.html" class="icon icon-home"> Enigma Protocol
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="BasicIntroduction.html">Basic Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="BasicIntroduction.html#how-enigma-works">How Enigma Works</a></li>
<li class="toctree-l2"><a class="reference internal" href="BasicIntroduction.html#the-enigma-testnet-what-s-inside">The Enigma Testnet - What’s Inside?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="TechnicalIntroduction.html">Technical Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="TechnicalIntroduction.html#how-enigma-works">How Enigma Works</a></li>
<li class="toctree-l2"><a class="reference internal" href="TechnicalIntroduction.html#the-enigma-testnet-what-s-inside">The Enigma Testnet - What’s Inside?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="HowToUseThisDocumentation.html">How to use this Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="HowToUseThisDocumentation.html#getting-hands-on-with-the-code">Getting Hands-on with the Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToUseThisDocumentation.html#understanding-the-enigma-protocol">Understanding the Enigma Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="HowToUseThisDocumentation.html#high-level-information">High-level information</a></li>
<li class="toctree-l3"><a class="reference internal" href="HowToUseThisDocumentation.html#low-level-information">Low-level information</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="HowToUseThisDocumentation.html#learning-about-enigma-s-encryption">Learning about Enigma’s Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToUseThisDocumentation.html#enigma-use-cases">Enigma Use-Cases</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="AboutThisRelease.html">About this Release</a><ul>
<li class="toctree-l2"><a class="reference internal" href="AboutThisRelease.html#selected-features-of-this-release">Selected features of this release</a></li>
<li class="toctree-l2"><a class="reference internal" href="AboutThisRelease.html#assumptions-made-in-this-testnet-release">Assumptions made in this testnet release</a></li>
<li class="toctree-l2"><a class="reference internal" href="AboutThisRelease.html#on-rust">On Rust</a></li>
<li class="toctree-l2"><a class="reference internal" href="AboutThisRelease.html#on-sgx">On SGX</a></li>
<li class="toctree-l2"><a class="reference internal" href="AboutThisRelease.html#on-coupling-with-ethereum">On Coupling with Ethereum</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="GettingStarted.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="GettingStarted.html#frequently-asked-questions">Frequently Asked Questions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="GettingStarted.html#hardware-and-software-mode-what-s-the-difference">Hardware and software mode - what’s the difference?</a></li>
<li class="toctree-l3"><a class="reference internal" href="GettingStarted.html#how-do-i-know-if-my-system-has-an-sgx-enabled-cpu">How do I know if my system has an SGX-enabled CPU?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="GettingStarted.html#testnet-limitations">Testnet Limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="GettingStarted.html#system-requirements">System Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="GettingStarted.html#setting-up-the-testnet">Setting up the Testnet</a></li>
<li class="toctree-l2"><a class="reference internal" href="GettingStarted.html#deploying-the-network">Deploying the Network</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Writing a Secret Contract</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#example-01-the-millionaires-problem">Example 01: The Millionaires Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-02-secret-auctions">Example 02: Secret Auctions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-it-works">How it Works</a></li>
<li class="toctree-l3"><a class="reference internal" href="#breaking-down-the-code">Breaking Down the Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-contract-state">The Contract State</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-bidding-process">The Bidding Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="#post-auction-callable-and-callback">Post-Auction: Callable and Callback</a></li>
<li class="toctree-l3"><a class="reference internal" href="#post-auction-withdrawls">Post-Auction: Withdrawls</a></li>
<li class="toctree-l3"><a class="reference internal" href="#design-considerations">Design Considerations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="CreateReactFrontend.html">Creating a React Front-End</a><ul>
<li class="toctree-l2"><a class="reference internal" href="CreateReactFrontend.html#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="SystemDesign.html">System Design</a><ul>
<li class="toctree-l2"><a class="reference internal" href="SystemDesign.html#enigma-js-client-library">Enigma-JS Client Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="SystemDesign.html#enigma-contract">Enigma Contract</a><ul>
<li class="toctree-l3"><a class="reference internal" href="SystemDesign.html#tracking-of-computation-tasks">Tracking of Computation Tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="SystemDesign.html#events">Events</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="SystemDesign.html#principal-node">Principal Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="SystemDesign.html#enigma-node">Enigma Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="SystemDesign.html#surface">Surface</a></li>
<li class="toctree-l2"><a class="reference internal" href="SystemDesign.html#core">Core</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="NetworkTopology.html">Network Topology</a></li>
<li class="toctree-l1"><a class="reference internal" href="SoftwareArchitecture.html">Software Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="SoftwareArchitecture.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="SoftwareArchitecture.html#subsystem-decomposition">Subsystem Decomposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="SoftwareArchitecture.html#logical-components">Logical Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="SoftwareArchitecture.html#mapping-between-subsystems-and-logical-components">Mapping Between Subsystems and Logical Components</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="SubsystemArchitecture.html">Subsystem Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="SubsystemArchitecture.html#registration">Registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="SubsystemArchitecture.html#client-encryption-and-storage">Client Encryption and Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="SubsystemArchitecture.html#worker-selection">Worker Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="SubsystemArchitecture.html#computation">Computation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="SubsystemArchitecture.html#payment-of-the-computation-fee">Payment of the Computation Fee</a></li>
<li class="toctree-l3"><a class="reference internal" href="SubsystemArchitecture.html#deserialization-and-decryption">Deserialization and Decryption</a></li>
<li class="toctree-l3"><a class="reference internal" href="SubsystemArchitecture.html#preprocessing">Preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="SubsystemArchitecture.html#execution-in-evm">Execution in EVM</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="SubsystemArchitecture.html#on-chain-verification">On-Chain Verification</a><ul>
<li class="toctree-l3"><a class="reference internal" href="SubsystemArchitecture.html#after-each-new-epoch">After Each New Epoch</a></li>
<li class="toctree-l3"><a class="reference internal" href="SubsystemArchitecture.html#post-computation">Post Computation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="SubsystemArchitecture.html#attestation">Attestation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Enigma-js.html">Enigma-JS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="Enigma-js.html#validatekeyhex"><strong>validateKeyHex</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="Enigma-js.html#getderivedkey"><strong>getDerivedKey</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="Enigma-js.html#encryptmessage"><strong>encryptMessage</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="Enigma-js.html#getpublickey"><strong>getPublicKey</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="Enigma-js.html#removetrailing0x"><strong>removeTrailing0x</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="Enigma-js.html#recoverpubkey"><strong>recoverPubKey</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="Enigma-js.html#verifysignature"><strong>verifySignature</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="Enigma-js.html#selectworker"><strong>selectWorker</strong></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="Glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="License.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="Appendix.html">Appendix</a><ul>
<li class="toctree-l2"><a class="reference internal" href="Appendix.html#cryptography">Cryptography</a><ul>
<li class="toctree-l3"><a class="reference internal" href="Appendix.html#elliptic-curve">Elliptic Curve</a></li>
<li class="toctree-l3"><a class="reference internal" href="Appendix.html#signing">Signing</a></li>
<li class="toctree-l3"><a class="reference internal" href="Appendix.html#encryption">Encryption</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Appendix.html#implementation">Implementation</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Enigma Protocol</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Writing a Secret Contract</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/SecretContracts.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="writing-a-secret-contract">
<h1>Writing a Secret Contract<a class="headerlink" href="#writing-a-secret-contract" title="Permalink to this headline">¶</a></h1>
<p>Secret contracts are smart contracts that execute code over Enigma’s decentralized
network without revealing input data, ensuring both integrity and confidentiality. Secret
contracts are written in a programming language called Solidity, and are implemented
very similarly to Ethereum-based smart contracts.</p>
<p><strong>NOTICE:</strong> Although the <code class="docutils literal"><span class="pre">enigma-docker-network</span></code> must stay running, at this point in the
guide you will be operating entirely out of the
<code class="docutils literal"><span class="pre">enigma-template-dapp</span></code> folder (the <code class="docutils literal"><span class="pre">dapp</span></code> terminal).</p>
<div class="section" id="example-01-the-millionaires-problem">
<h2>Example 01: The Millionaires Problem<a class="headerlink" href="#example-01-the-millionaires-problem" title="Permalink to this headline">¶</a></h2>
<p>The millionaires problem is a simple concept with complex solutions: How do two
individuals compare their net worth without ever exposing their actual value to
the other party?</p>
<p>Inside your <code class="docutils literal"><span class="pre">dapp</span></code> terminal, enter the <code class="docutils literal"><span class="pre">/contracts</span></code> folder and create a new
file called <code class="docutils literal"><span class="pre">MillionairesProblem.sol</span></code> and paste the following contract code within
it:</p>
<div class="highlight-rust"><div class="highlight"><pre><span class="n">pragma</span><span class="w"> </span><span class="n">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span><span class="w"></span>


<span class="n">contract</span><span class="w"> </span><span class="n">MillionairesProblem</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="c1">// Stores # of millionaires that have joined and stated their net worths</span>
<span class="w">       </span><span class="kt">uint</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">numMillionaires</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="c1">// Stores Millionaire structs (defined below)</span>
<span class="w">       </span><span class="n">Millionaire</span><span class="p">[]</span><span class="w"> </span><span class="n">millionaires</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="c1">// Stores address of richest millionaire; set in callback function below</span>
<span class="w">       </span><span class="n">address</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">richestMillionaire</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">address</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">owner</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">address</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">enigma</span><span class="p">;</span><span class="w"></span>

<span class="w">       </span><span class="c1">// Millionaire struct which holds encrypted address and net worth</span>
<span class="w">       </span><span class="k">struct</span><span class="w"> </span><span class="n">Millionaire</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="n">bytes</span><span class="w"> </span><span class="n">myAddress</span><span class="p">;</span><span class="w"></span>
<span class="w">               </span><span class="n">bytes</span><span class="w"> </span><span class="n">myNetWorth</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="c1">// Event emitted upon callback completion; watched from front end</span>
<span class="w">       </span><span class="n">event</span><span class="w"> </span><span class="n">CallbackFinished</span><span class="p">();</span><span class="w"></span>

<span class="w">       </span><span class="c1">// Modifier to ensure only enigma contract can call function</span>
<span class="w">       </span><span class="n">modifier</span><span class="w"> </span><span class="n">onlyEnigma</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="n">require</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">enigma</span><span class="p">);</span><span class="w"></span>
<span class="w">               </span><span class="n">_</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="c1">// Constructor called when new contract is deployed</span>
<span class="w">       </span><span class="n">constructor</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="n">_enigmaAddress</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">_owner</span><span class="p">)</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_owner</span><span class="p">;</span><span class="w"></span>
<span class="w">               </span><span class="n">enigma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_enigmaAddress</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="c1">// Add a new millionaire with encrypted address and net worth arguments</span>
<span class="w">       </span><span class="n">function</span><span class="w"> </span><span class="n">addMillionaire</span><span class="p">(</span><span class="n">bytes</span><span class="w"> </span><span class="n">_encryptedAddress</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">_encryptedNetWorth</span><span class="p">)</span><span class="w"></span>
<span class="w">               </span><span class="n">public</span><span class="w"></span>
<span class="w">       </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="n">Millionaire</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">millionaire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Millionaire</span><span class="p">({</span><span class="w"></span>
<span class="w">                       </span><span class="n">myAddress</span><span class="o">:</span><span class="w"> </span><span class="n">_encryptedAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">myNetWorth</span><span class="o">:</span><span class="w"> </span><span class="n">_encryptedNetWorth</span><span class="w"></span>
<span class="w">               </span><span class="p">});</span><span class="w"></span>
<span class="w">               </span><span class="n">millionaires</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">millionaire</span><span class="p">);</span><span class="w"></span>
<span class="w">               </span><span class="n">numMillionaires</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="c1">// Return encrypted address and net worth for a particular millionaire</span>
<span class="w">       </span><span class="n">function</span><span class="w"> </span><span class="n">getInfoForMillionaire</span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"></span>
<span class="w">               </span><span class="n">public</span><span class="w"></span>
<span class="w">               </span><span class="n">view</span><span class="w"></span>
<span class="w">               </span><span class="n">returns</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="n">Millionaire</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">millionaire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millionaires</span><span class="p">[</span><span class="n">index</span><span class="p">];</span><span class="w"></span>
<span class="w">               </span><span class="n">bytes</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">encryptedAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millionaire</span><span class="p">.</span><span class="n">myAddress</span><span class="p">;</span><span class="w"></span>
<span class="w">               </span><span class="n">bytes</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">encryptedNetWorth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millionaire</span><span class="p">.</span><span class="n">myNetWorth</span><span class="p">;</span><span class="w"></span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">encryptedAddress</span><span class="p">,</span><span class="w"> </span><span class="n">encryptedNetWorth</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="cm">/*</span>
<span class="cm">       CALLABLE FUNCTION run in SGX to decipher encrypted net worths to</span>
<span class="cm">       determine richest millionaire</span>
<span class="cm">       */</span><span class="w"></span>
<span class="w">       </span><span class="n">function</span><span class="w"> </span><span class="n">computeRichest</span><span class="p">(</span><span class="n">address</span><span class="p">[]</span><span class="w"> </span><span class="n">_addresses</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="p">[]</span><span class="w"> </span><span class="n">_netWorths</span><span class="p">)</span><span class="w"></span>
<span class="w">               </span><span class="n">public</span><span class="w"></span>
<span class="w">               </span><span class="kr">pure</span><span class="w"></span>
<span class="w">               </span><span class="n">returns</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="kt">uint</span><span class="w"> </span><span class="n">maxIndex</span><span class="p">;</span><span class="w"></span>
<span class="w">               </span><span class="kt">uint</span><span class="w"> </span><span class="n">maxValue</span><span class="p">;</span><span class="w"></span>
<span class="w">               </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_netWorths</span><span class="p">.</span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_netWorths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                               </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_netWorths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">                               </span><span class="n">maxIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">                       </span><span class="p">}</span><span class="w"></span>
<span class="w">               </span><span class="p">}</span><span class="w"></span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="n">_addresses</span><span class="p">[</span><span class="n">maxIndex</span><span class="p">];</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="cm">/*</span>
<span class="cm">       CALLBACK FUNCTION to change contract state tracking richest</span>
<span class="cm">       millionaire&#39;s name</span>
<span class="cm">       */</span><span class="w"></span>
<span class="w">       </span><span class="n">function</span><span class="w"> </span><span class="n">setRichestAddress</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="n">_address</span><span class="p">)</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">onlyEnigma</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="n">richestMillionaire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_address</span><span class="p">;</span><span class="w"></span>
<span class="w">               </span><span class="n">emit</span><span class="w"> </span><span class="n">CallbackFinished</span><span class="p">();</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>As mentioned above, the design principles and syntax (state variables, structs, constructors,
functions, events, modifiers, etc.) are very similar to Ethereum smart contracts, the two major
differences being the <code class="docutils literal"><span class="pre">callable</span></code> and <code class="docutils literal"><span class="pre">callback</span></code> functions.</p>
<dl class="docutils">
<dt>Callable</dt>
<dd>This is a public function that runs secret computations inside the SGX enclave. It is a <code class="docutils literal"><span class="pre">pure</span></code>
function, meaning it does not read from nor write to the contract state, but computes solely
off of the arguments that are passed to it. Although these encrypted values are passed via
the front-end interface, the decryption automatically occurs within this function.
In the case of this <code class="docutils literal"><span class="pre">computeRichest</span></code> callable example, the arguments take the form
of <code class="docutils literal"><span class="pre">_addresses</span></code> and <code class="docutils literal"><span class="pre">_netWorths</span></code> - more specifically, types <code class="docutils literal"><span class="pre">address[]</span></code> and <code class="docutils literal"><span class="pre">uint[]</span></code>.
These arguments are decrypted automatically, and it is now possible to determine the party with
the highest net worth and retrieve the decrypted address at the same index. This decrypted
address is to be used as the input for the <code class="docutils literal"><span class="pre">callback</span></code> function.</dd>
<dt>Callback</dt>
<dd>This is a public function automatically called by the worker (the <code class="docutils literal"><span class="pre">onlyEnigma()</span></code> modifier)
after the callable function is completed. It is responsible for committing the results and
altering the contract state. In this example, we input the <code class="docutils literal"><span class="pre">_address</span></code> we have obtained from the
<code class="docutils literal"><span class="pre">callable</span></code>, store it as the <code class="docutils literal"><span class="pre">richestMillionaire</span></code> state variable, and emit the
<code class="docutils literal"><span class="pre">CallbackFinished</span></code> event. The output of the final event is important, as it is possible to set
up an event watcher within the front-end to perform a task upon successful completion.</dd>
</dl>
<p>The next step is to create a contract ‘factory design pattern’ so fresh instances of the
<code class="docutils literal"><span class="pre">MillionairesProblem</span></code> can be generated on-demand. From the <code class="docutils literal"><span class="pre">/contracts</span></code> folder, create a new
file called <code class="docutils literal"><span class="pre">MillionairesProblemFactory.sol</span></code> and paste the following code:</p>
<div class="highlight-rust"><div class="highlight"><pre><span class="n">pragma</span><span class="w"> </span><span class="n">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span><span class="w"></span>
<span class="n">import</span><span class="w"> </span><span class="s">&quot;./MillionairesProblem.sol&quot;</span><span class="p">;</span><span class="w"></span>


<span class="n">contract</span><span class="w"> </span><span class="n">MillionairesProblemFactory</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">address</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">enigmaAddress</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="c1">// List of addresses for deployed MillionaireProblem instances</span>
<span class="w">       </span><span class="n">address</span><span class="p">[]</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">millionairesProblems</span><span class="p">;</span><span class="w"></span>

<span class="w">       </span><span class="n">constructor</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="n">_enigmaAddress</span><span class="p">)</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="n">enigmaAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_enigmaAddress</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="c1">// Create a new MillionaireProblem and store address to array</span>
<span class="w">       </span><span class="n">function</span><span class="w"> </span><span class="n">createNewMillionairesProblem</span><span class="p">()</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="n">address</span><span class="w"> </span><span class="n">newMillionairesProblem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MillionairesProblem</span><span class="p">(</span><span class="w"></span>
<span class="w">                       </span><span class="n">enigmaAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="w"></span>
<span class="w">               </span><span class="p">);</span><span class="w"></span>
<span class="w">               </span><span class="n">millionairesProblems</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">newMillionairesProblem</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="c1">// Obtain list of all deployed MillionaireProblem instances</span>
<span class="w">       </span><span class="n">function</span><span class="w"> </span><span class="n">getMillionairesProblems</span><span class="p">()</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">view</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="n">millionairesProblems</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>All of the necessary solidity code has been completed at this point. The final step is to
implement a migration script that will deploy the <code class="docutils literal"><span class="pre">MillionairesProblemFactory</span></code> contract.
From within the <code class="docutils literal"><span class="pre">migrations/</span></code> folder, create a script called <code class="docutils literal"><span class="pre">2_deploy_millionaires_problem_factory.js</span></code>
and paste the following:</p>
<div class="highlight-rust"><div class="highlight"><pre><span class="kr">const</span><span class="w"> </span><span class="n">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s">&quot;http&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kr">const</span><span class="w"> </span><span class="n">MillionairesProblemFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">artifacts</span><span class="p">.</span><span class="n">require</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="s">&quot;MillionairesProblemFactory.sol&quot;</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="n">module</span><span class="p">.</span><span class="n">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">deployer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">       </span><span class="n">deployer</span><span class="w"></span>
<span class="w">           </span><span class="p">.</span><span class="n">then</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Promise</span><span class="p">((</span><span class="n">resolve</span><span class="p">,</span><span class="w"> </span><span class="n">reject</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                   </span><span class="cm">/*</span>
<span class="cm">                   Obtain the Enigma contract address hosted at this port</span>
<span class="cm">                   upon enigma-docker-network launch</span>
<span class="cm">                   */</span><span class="w"></span>
<span class="w">                   </span><span class="kr">const</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="w"></span>
<span class="w">                       </span><span class="s">&quot;http://localhost:8081&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">response</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                           </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">                               </span><span class="n">response</span><span class="p">.</span><span class="n">statusCode</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">                               </span><span class="n">response</span><span class="p">.</span><span class="n">statusCode</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">299</span><span class="w"></span>
<span class="w">                           </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                               </span><span class="n">reject</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">new</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="w"></span>
<span class="w">                                       </span><span class="s">&quot;Failed to load page, status code: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                                           </span><span class="n">response</span><span class="p">.</span><span class="n">statusCode</span><span class="w"></span>
<span class="w">                                   </span><span class="p">)</span><span class="w"></span>
<span class="w">                               </span><span class="p">);</span><span class="w"></span>
<span class="w">                           </span><span class="p">}</span><span class="w"></span>
<span class="w">                           </span><span class="kr">const</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"></span>
<span class="w">                           </span><span class="n">response</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">body</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">chunk</span><span class="p">));</span><span class="w"></span>
<span class="w">                           </span><span class="n">response</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;end&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">resolve</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)));</span><span class="w"></span>
<span class="w">                       </span><span class="p">}</span><span class="w"></span>
<span class="w">                   </span><span class="p">);</span><span class="w"></span>
<span class="w">                   </span><span class="n">request</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reject</span><span class="p">(</span><span class="n">err</span><span class="p">));</span><span class="w"></span>
<span class="w">               </span><span class="p">});</span><span class="w"></span>
<span class="w">           </span><span class="p">})</span><span class="w"></span>
<span class="w">           </span><span class="c1">// Deploy MillionairesProblemFactory with the Enigma contract address</span>
<span class="w">           </span><span class="p">.</span><span class="n">then</span><span class="p">(</span><span class="n">enigmaAddress</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">               </span><span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Got Enigma Contract address: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">enigmaAddress</span><span class="p">);</span><span class="w"></span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="n">deployer</span><span class="p">.</span><span class="n">deploy</span><span class="p">(</span><span class="w"></span>
<span class="w">                   </span><span class="n">MillionairesProblemFactory</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">enigmaAddress</span><span class="w"></span>
<span class="w">               </span><span class="p">);</span><span class="w"></span>
<span class="w">           </span><span class="p">})</span><span class="w"></span>
<span class="w">           </span><span class="p">.</span><span class="n">catch</span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">console</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">))</span><span class="w"></span>
<span class="w">   </span><span class="p">);</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>The function of this script is to pass the Enigma contract address that was deployed
when the Docker container was launched ( found at <code class="docutils literal"><span class="pre">http://localhost:8081</span></code>), and deploy
a fresh <code class="docutils literal"><span class="pre">MillionairesProblemFactory</span></code> instance with this address as an argument.</p>
<p><strong>NOTICE:</strong> To create new contracts or modify existing ones, you must redeploy to the network
with the following command: <code class="docutils literal"><span class="pre">darq-truffle</span> <span class="pre">migrate</span> <span class="pre">--reset</span> <span class="pre">--network</span> <span class="pre">development</span></code></p>
</div>
<div class="section" id="example-02-secret-auctions">
<h2>Example 02: Secret Auctions<a class="headerlink" href="#example-02-secret-auctions" title="Permalink to this headline">¶</a></h2>
<p>Auction theory is a complex economics field involving significant academic research, and thus
there are a large variety of auction types which enable different economic and social behaviours.
To best showcase the value of cryptographic privacy in auctions, the below example outlines a
simple <strong>sealed-bid auction</strong>, which is a variation that protects the value of bids during the
bidding process.</p>
<p><strong>NOTICE:</strong> Several <a class="reference external" href="#design-considerations">design choices</a> were necessary due to the current
<a class="reference external" href="GettingStarted#testnet-limitations">testnet limitations</a> of the Enigma Protocol - though if you have
any suggestions for how to improve the methods used, do <a class="reference external" href="https://forum.enigma.co">let us know!</a></p>
<div class="section" id="how-it-works">
<h3>How it Works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h3>
<p><strong>1.</strong> A user creates a new auction by sending a transaction to an ‘Auction Factory’,
which acts as a proxy for deploying new auction contracts.</p>
<p><strong>2.</strong> The Auction Factory specifies an ERC721 contract which will mint the auction reward.</p>
<p><strong>3.</strong> A potential bidder stakes Ether in the auction contract and acts as collateral for a potential bid.</p>
<p><strong>4.</strong> Users will send encrypted bids to the contract. Anyone can change their bid during the bidding process.</p>
</div>
<div class="section" id="breaking-down-the-code">
<h3>Breaking Down the Code<a class="headerlink" href="#breaking-down-the-code" title="Permalink to this headline">¶</a></h3>
<p>This section explains the individual logic components of the code. To view the combined full
source of the below snippets, see
<a class="reference external" href="https://github.com/enigmampc/secret-contracts/blob/master/contracts/Auction.sol">this repository</a>.</p>
</div>
<div class="section" id="the-contract-state">
<h3>The Contract State<a class="headerlink" href="#the-contract-state" title="Permalink to this headline">¶</a></h3>
<div class="highlight-rust"><div class="highlight"><pre><span class="k">enum</span><span class="w"> </span><span class="n">AuctionState</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">IN_PROGRESS</span><span class="p">,</span><span class="w"> </span><span class="n">CALCULATING</span><span class="p">,</span><span class="w"> </span><span class="n">COMPLETED</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="n">event</span><span class="w"> </span><span class="n">Bid</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="n">bidder</span><span class="p">);</span><span class="w"></span>
<span class="n">event</span><span class="w"> </span><span class="n">Winner</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="n">winner</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="n">bidValue</span><span class="p">);</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="n">Bidder</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">hasBidded</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">bidValue</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">address</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">owner</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">startTime</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">endTime</span><span class="p">;</span><span class="w"></span>
<span class="n">address</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">winner</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">startingPrice</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">winningPrice</span><span class="p">;</span><span class="w"></span>
<span class="n">mapping</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Bidder</span><span class="p">)</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">bidders</span><span class="p">;</span><span class="w"></span>
<span class="n">mapping</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint</span><span class="p">)</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">stakeAmounts</span><span class="p">;</span><span class="w"></span>
<span class="n">address</span><span class="p">[]</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">bidderAddresses</span><span class="p">;</span><span class="w"></span>
<span class="n">Enigma</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">enigma</span><span class="p">;</span><span class="w"></span>
<span class="n">EnigmaCollectible</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">enigmaCollectible</span><span class="p">;</span><span class="w"></span>
<span class="n">AuctionState</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w"></span>
<span class="kt">bool</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="n">rewardClaimed</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>This section of the code defines several functions:</p>
<p><strong>Enum:</strong> The state of the auction is defined by an enum called <code class="docutils literal"><span class="pre">AuctionState</span></code>. “Calculating”
refers to the period when the Enigma network is determining the winner.</p>
<p><strong>Events:</strong> <code class="docutils literal"><span class="pre">Bid</span></code> refers to individual bids and <code class="docutils literal"><span class="pre">Winner</span></code> signals the final update of the winner.</p>
<p><strong>Bidder Struct:</strong> Each address has an associated <code class="docutils literal"><span class="pre">Bidder</span></code> struct which contains a boolean
determining if they have already bidded and their current encrypted bid.</p>
<p><strong>State Variables:</strong> Most of the variables are straightforward. Note that <code class="docutils literal"><span class="pre">stakeAmounts</span></code>
refers to the amount of Ether (in wei) that each address has staked.</p>
</div>
<div class="section" id="the-bidding-process">
<h3>The Bidding Process<a class="headerlink" href="#the-bidding-process" title="Permalink to this headline">¶</a></h3>
<p>Bidding begins by users staking Ether in the contract, which acts as a binding commitment
towards paying their bid value in the case they are victorious. It is assumed that users will
bid an amount less than their deposit in order to obscure the true value of their bid (See
<a class="reference external" href="#design-considerations">design considerations</a>).</p>
<p><strong>NOTICE:</strong> Users can also increase their stake anytime during the bidding process.</p>
<div class="highlight-rust"><div class="highlight"><pre><span class="n">function</span><span class="w"> </span><span class="n">stake</span><span class="p">()</span><span class="w"> </span><span class="n">payable</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AuctionState</span><span class="p">.</span><span class="n">IN_PROGRESS</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">stakeAmounts</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The contract will now check if the auction is open for bidding and whether the user has
enough stake to fulfill the minimum bid value (specified at the creation of the auction).
If these requirementsare met, a bid can be placed on the contract.</p>
<p><strong>NOTICE:</strong> Similar to the staking function, a user can update their bid anytime during
the bidding process</p>
<div class="highlight-rust"><div class="highlight"><pre><span class="n">function</span><span class="w"> </span><span class="n">bid</span><span class="p">(</span><span class="n">bytes</span><span class="w"> </span><span class="n">_bidValue</span><span class="p">)</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">endTime</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">stakeAmounts</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">startingPrice</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">bidders</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">].</span><span class="n">bidValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_bidValue</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bidders</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">].</span><span class="n">hasBidded</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">bidders</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">].</span><span class="n">hasBidded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">emit</span><span class="w"> </span><span class="n">Bid</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Finally, the creator of the auction will end the auction when the bidding period expires.</p>
<div class="highlight-rust"><div class="highlight"><pre><span class="n">function</span><span class="w"> </span><span class="n">endAuction</span><span class="p">()</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="n">isOwner</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AuctionState</span><span class="p">.</span><span class="n">IN_PROGRESS</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">endTime</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuctionState</span><span class="p">.</span><span class="n">CALCULATING</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="post-auction-callable-and-callback">
<h3>Post-Auction: Callable and Callback<a class="headerlink" href="#post-auction-callable-and-callback" title="Permalink to this headline">¶</a></h3>
<p>After the auction has come to an end, the dApp which deployed the contracts
will submit a task to the Enigma Network in order to calculate the winner.
This is where the standard <code class="docutils literal"><span class="pre">callable</span></code> and <code class="docutils literal"><span class="pre">callback</span></code> functions that are
fundamental to the privacy-preserving nature of Enigma are utilized.</p>
<div class="highlight-rust"><div class="highlight"><pre><span class="w"> </span><span class="cm">/*</span>
<span class="cm">  * The callable function. Gets the highest bidder and bid amount for the auction.</span>
<span class="cm">  */</span><span class="w"></span>

<span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">getHighestBidder</span><span class="p">(</span><span class="n">address</span><span class="p">[]</span><span class="w"> </span><span class="n">_bidders</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="p">[]</span><span class="w"> </span><span class="n">_bidAmounts</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="p">[]</span><span class="w"> </span><span class="n">_stakeAmounts</span><span class="p">)</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="kr">pure</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">address</span><span class="w"> </span><span class="n">highestBidder</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">uint</span><span class="w"> </span><span class="n">highestBidAmount</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_bidders</span><span class="p">.</span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">_bidAmounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">highestBidAmount</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">_bidAmounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">_stakeAmounts</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">highestBidAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_bidAmounts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">       </span><span class="n">highestBidder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_bidders</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">highestBidder</span><span class="p">,</span><span class="w"> </span><span class="n">highestBidAmount</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="cm">/*</span>
<span class="cm">  * The callback function. Updates the contract state.</span>
<span class="cm">  */</span><span class="w"></span>

<span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">updateWinner</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="n">_highestBidder</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="n">_highestBidAmount</span><span class="p">)</span><span class="w"> </span><span class="n">public</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_highestBidder</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="n">winningPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_highestBidAmount</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuctionState</span><span class="p">.</span><span class="n">COMPLETED</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="n">stakeAmounts</span><span class="p">[</span><span class="n">_highestBidder</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">winningPrice</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="n">emit</span><span class="w"> </span><span class="n">Winner</span><span class="p">(</span><span class="n">_highestBidder</span><span class="p">,</span><span class="w"> </span><span class="n">_highestBidAmount</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<dl class="docutils">
<dt>The <code class="docutils literal"><span class="pre">callable</span></code> function</dt>
<dd>This is the function that is computed by a randomly selected
SGX node on the Enigma network. In our example,
this function calculates the highest bidder of the auction. It simply finds
the user with the highest corresponding bid and checks whether the bid value
is less than or equal to the amount of Ether that the user has staked. The
bid is rendered invalid if its value is greater than its prior stake.</dd>
<dt>The <code class="docutils literal"><span class="pre">callback</span></code> function</dt>
<dd>This is the function that is called by the Enigma contract
after the <code class="docutils literal"><span class="pre">callable</span></code> has finished. In our auction contract, the <code class="docutils literal"><span class="pre">callback</span></code> will
update the state variables <code class="docutils literal"><span class="pre">winner</span></code>, <code class="docutils literal"><span class="pre">winningPrice</span></code>, and <code class="docutils literal"><span class="pre">state</span></code> as well as
decrease the stake of the winner.</dd>
</dl>
</div>
<div class="section" id="post-auction-withdrawls">
<h3>Post-Auction: Withdrawls<a class="headerlink" href="#post-auction-withdrawls" title="Permalink to this headline">¶</a></h3>
<p>Bidders who did not win the auction withdraw all their prior staked ether, and the winner
can claim their reward.</p>
<div class="highlight-rust"><div class="highlight"><pre><span class="n">function</span><span class="w"> </span><span class="n">withdraw</span><span class="p">()</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AuctionState</span><span class="p">.</span><span class="n">COMPLETED</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">stakeAmounts</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stakeAmounts</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">stakeAmounts</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The winners rewards are claimed by calling the <code class="docutils literal"><span class="pre">claimReward</span></code> function, which mints
an ERC721 token specified in the <code class="docutils literal"><span class="pre">Auction</span> <span class="pre">Factory</span></code>. The winner does not need to send
any Ether, as the contract takes the bid amount from their stake.</p>
<div class="highlight-rust"><div class="highlight"><pre><span class="n">function</span><span class="w"> </span><span class="n">claimReward</span><span class="p">()</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AuctionState</span><span class="p">.</span><span class="n">COMPLETED</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">winner</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="o">!</span><span class="n">rewardClaimed</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">rewardClaimed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">enigmaCollectible</span><span class="p">.</span><span class="n">mintToken</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">endTime</span><span class="p">);</span><span class="w">  </span><span class="c1">// mint an ERC721 Enigma Collectible with arbitrary  tokenID (just use the end time)</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Finally, the creator of the auction can withdraw the winner’s stake.</p>
<div class="highlight-rust"><div class="highlight"><pre><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">claimEther</span><span class="p">()</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="n">isOwner</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AuctionState</span><span class="p">.</span><span class="n">COMPLETED</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">winningPrice</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="design-considerations">
<h3>Design Considerations<a class="headerlink" href="#design-considerations" title="Permalink to this headline">¶</a></h3>
<p>Please note that this design has a few limitations:</p>
<p><strong>1.</strong> The staking mechanism adds complexity for users as it presents an extra step to the
bidding process. However, if it is not included in this system, an address could bid an
extremely high value, become the winner and not claim the reward, causing the auction to
stay in limbo.</p>
<p><strong>2.</strong> Since the callable function cannot access contract state in the current release of
Enigma, the stake amounts of each user is sent as an argument to the callback function. This
causes the dApp to become an ‘oracle’ to the Enigma network, since it is responsible for
retrieving these stake amounts. In a future release, Enigma nodes will be able to call view
functions of Ethereum contracts in order to address this dependency.</p>
<p><strong>3.</strong> Auction rewards are minted to simplify the code. In the future, we expect that this
mechanism will include adding an existing NFT to the auction contract as the item being auctioned.</p>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="CreateReactFrontend.html" class="btn btn-neutral float-right" title="Creating a React Front-End" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="GettingStarted.html" class="btn btn-neutral" title="Getting Started" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018 Enigma MPC, Inc.
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>